<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Platformer Pixel Art avec Menu Paramètres</title>
<style>
  body, html {
    margin: 0; padding: 0; overflow: hidden; background: #87ceeb;
    font-family: monospace;
  }
  #gameCanvas {
    display: block;
    margin: auto;
    image-rendering: pixelated;
    background: #87ceeb;
  }
  #touchControls {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15px;
    user-select: none;
    z-index: 1000;
  }
  .touch-btn {
    width: 60px;
    height: 60px;
    background: rgba(255,255,255,0.5);
    border-radius: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 30px;
    color: #333;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
    touch-action: none;
    user-select: none;
  }
  .touch-btn:active {
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
  }
  #messageOverlay, #settingsOverlay {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 24px;
    font-family: monospace;
    z-index: 2000;
    display: none;
  }
  #messageOverlay button, #settingsOverlay button {
    margin-top: 20px;
    padding: 10px 30px;
    font-size: 20px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    background: #28a745;
    color: white;
    user-select: none;
  }
  #messageOverlay button:hover, #settingsOverlay button:hover {
    background: #218838;
  }

  #settingsOverlay {
    max-width: 400px;
    padding: 20px;
  }
  #settingsOverlay label {
    display: block;
    margin-top: 15px;
    font-size: 18px;
  }
  #settingsOverlay input[type="text"] {
    width: 70px;
    font-size: 18px;
    padding: 4px 6px;
    margin-left: 10px;
    border-radius: 6px;
    border: none;
    text-align: center;
  }
  #settingsOverlay input[type="checkbox"] {
    margin-left: 10px;
    transform: scale(1.3);
    cursor: pointer;
  }
  #settingsOverlay select {
    font-size: 18px;
    margin-left: 10px;
    border-radius: 6px;
  }

  #settingsBtn {
    position: fixed;
    top: 15px;
    right: 15px;
    z-index: 1500;
    background: rgba(255,255,255,0.8);
    border-radius: 8px;
    border: none;
    padding: 10px 15px;
    font-size: 18px;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
  }
  #settingsBtn:hover {
    background: rgba(255,255,255,1);
  }
</style>
</head>
<body>
<button id="settingsBtn">⚙️ Paramètres</button>

<canvas id="gameCanvas" width="480" height="270"></canvas>

<div id="touchControls">
  <div id="btnLeft" class="touch-btn">&#8592;</div>
  <div id="btnJump" class="touch-btn">&#8679;</div>
  <div id="btnRight" class="touch-btn">&#8594;</div>
</div>

<div id="messageOverlay">
  <div id="messageText"></div>
  <button id="messageButton"></button>
</div>

<div id="settingsOverlay">
  <h2>Paramètres</h2>
  <label>Déplacement Gauche :
    <input type="text" id="keyLeft" maxlength="1" value="A" />
  </label>
  <label>Déplacement Droite :
    <input type="text" id="keyRight" maxlength="1" value="D" />
  </label>
  <label>Saut :
    <input type="text" id="keyJump" maxlength="1" value="W" />
  </label>
  <label>Vitesse du joueur :
    <input type="range" id="speedRange" min="1" max="10" value="3" />
    <span id="speedValue">3</span>
  </label>
  <label>Musique :
    <input type="checkbox" id="musicToggle" checked />
  </label>
  <label>Sons (pour futurs effets) :
    <input type="checkbox" id="soundToggle" checked />
  </label>
  <label>Afficher boutons tactiles :
    <input type="checkbox" id="touchToggle" checked />
  </label>
  <label>Skin du joueur :
    <select id="skinSelect">
      <option value="yellow">Jaune Classique</option>
      <option value="blue">Bleu</option>
      <option value="green">Vert</option>
      <option value="red">Rouge</option>
    </select>
  </label>
  <button id="closeSettings">Fermer</button>
</div>

<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  const messageOverlay = document.getElementById("messageOverlay");
  const messageText = document.getElementById("messageText");
  const messageButton = document.getElementById("messageButton");

  const settingsBtn = document.getElementById("settingsBtn");
  const settingsOverlay = document.getElementById("settingsOverlay");
  const closeSettingsBtn = document.getElementById("closeSettings");

  // Paramètres contrôles
  let controls = {
    left: "a",
    right: "d",
    jump: "w"
  };
  // Vitesse joueur ajustable
  let playerSpeed = 3;
  // Musique activée ?
  let musicOn = true;
  // Sons activés (placeholder)
  let soundOn = true;
  // Boutons tactiles visibles
  let touchButtonsVisible = true;

  // Skins (couleurs)
  const skins = {
    yellow: { body: "#f5d742", legs: "#d9b72e" },
    blue: { body: "#4267f5", legs: "#2e44d9" },
    green: { body: "#42f56c", legs: "#2ed94a" },
    red: { body: "#f54242", legs: "#d92e2e" }
  };
  let currentSkin = "yellow";

  // Adaptation taille canvas à la fenêtre (ratio 16:9)
  function resize() {
    const ratio = 16/9;
    let w = window.innerWidth;
    let h = window.innerHeight;
    if (w / h > ratio) {
      w = h * ratio;
    } else {
      h = w / ratio;
    }
    canvas.style.width = w + "px";
    canvas.style.height = h + "px";
  }
  window.addEventListener("resize", resize);
  resize();

  // Variables joueur et niveau
  const baseWidth = 480;
  const baseHeight = 270;

  let keysDown = {};
  let mobileControls = { left: false, right: false, jump: false };
  let gamePaused = false;
  let playerDead = false;
  let levelCompleted = false;

  // Player
  const player = {
    x: 40, y: 200, width: 16, height: 24,
    vx: 0, vy: 0,
    onGround: false,
    jumping: false,
    animFrame: 0,
    animTick: 0
  };

  const gravity = 0.5;
  const friction = 0.8;

  // Levels - plateformes, trous, lasers
  const levels = [
    [
      {type:"platform", x:0, y:250, length:30},
      {type:"hole", x:20, y:260, length:4},
      {type:"laser", x:40, y:230, length:5, dir:1}
    ],
    // ... Ajoute d'autres niveaux ici ...
  ];
  let currentLevel = 0;
  const maxLevel = levels.length - 1;

  // Touch buttons
  const btnLeft = document.getElementById("btnLeft");
  const btnRight = document.getElementById("btnRight");
  const btnJump = document.getElementById("btnJump");

  // Gestion boutons tactiles
  btnLeft.addEventListener("touchstart", e => { e.preventDefault(); mobileControls.left = true; });
  btnLeft.addEventListener("touchend", e => { e.preventDefault(); mobileControls.left = false; });
  btnRight.addEventListener("touchstart", e => { e.preventDefault(); mobileControls.right = true; });
  btnRight.addEventListener("touchend", e => { e.preventDefault(); mobileControls.right = false; });
  btnJump.addEventListener("touchstart", e => { e.preventDefault(); mobileControls.jump = true; });
  btnJump.addEventListener("touchend", e => { e.preventDefault(); mobileControls.jump = false; });

  // Clavier
  window.addEventListener("keydown", e => {
    keysDown[e.key.toLowerCase()] = true;
  });
  window.addEventListener("keyup", e => {
    keysDown[e.key.toLowerCase()] = false;
  });

  // Affichage message
  function showMessage(text, btnText, btnCallback) {
    messageText.textContent = text;
    messageButton.textContent = btnText;
    messageOverlay.style.display = "flex";
    messageButton.onclick = btnCallback;
  }
  function hideMessage() {
    messageOverlay.style.display = "none";
  }

  // Reset joueur
  function resetPlayer() {
    player.x = 40;
    player.y = 200;
    player.vx = 0;
    player.vy = 0;
    player.onGround = false;
    player.jumping = false;
    playerDead = false;
    levelCompleted = false;
  }

  // Contrôles pour la frame
  function handleInput() {
    player.vx = 0;
    if (keysDown[controls.left] || mobileControls.left) player.vx = -playerSpeed;
    if (keysDown[controls.right] || mobileControls.right) player.vx = playerSpeed;
    if ((keysDown[controls.jump] || mobileControls.jump) && player.onGround && !player.jumping) {
      player.vy = -10;
      player.jumping = true;
      player.onGround = false;
    }
    if (!keysDown[controls.jump] && !mobileControls.jump) {
      player.jumping = false;
    }
  }

  // Mise à jour joueur
  function updatePlayer() {
    handleInput();

    player.vy += gravity;
    player.x += player.vx;
    player.y += player.vy;

    // Collision sol / plateformes
    player.onGround = false;
    const level = levels[currentLevel];
    for (const obj of level) {
      if (obj.type === "platform") {
        const platX1 = obj.x * 16;
        const platX2 = (obj.x + obj.length) * 16;
        const platY = obj.y;
        if (
          player.x + player.width > platX1 &&
          player.x < platX2 &&
          player.y + player.height >= platY &&
          player.y + player.height <= platY + 10 &&
          player.vy >= 0
        ) {
          player.y = platY - player.height;
          player.vy = 0;
          player.onGround = true;
        }
      }
      // Trou mortel
      if (obj.type === "hole") {
        const holeX1 = obj.x * 16;
        const holeX2 = (obj.x + obj.length) * 16;
        const holeY = obj.y;
        if (
          player.x + player.width > holeX1 &&
          player.x < holeX2 &&
          player.y + player.height > holeY - 10
        ) {
          playerDead = true;
        }
      }
      // Laser simple bougeant horizontalement
      if (obj.type === "laser") {
        const laserX1 = obj.x * 16 + Math.sin(Date.now() / 500) * 20 * obj.dir;
        const laserX2 = laserX1 + obj.length * 16;
        const laserY1 = obj.y;
        const laserY2 = obj.y + 3 * 16;
        if (
          player.x + player.width > laserX1 &&
          player.x < laserX2 &&
          player.y + player.height > laserY1 &&
          player.y < laserY2
        ) {
          playerDead = true;
        }
      }
    }

    // Limites du terrain
    if (player.x < 0) player.x = 0;
    if (player.x + player.width > baseWidth) player.x = baseWidth - player.width;
    if (player.y > baseHeight) playerDead = true;

    // Animation
    player.animTick++;
    if (player.animTick > 10) {
      player.animTick = 0;
      player.animFrame = (player.animFrame + 1) % 2;
    }
  }

  // Dessine background cartoon simple
  function drawBackground() {
    // ciel bleu dégradé
    const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    skyGradient.addColorStop(0, "#87ceeb");
    skyGradient.addColorStop(1, "#cceeff");
    ctx.fillStyle = skyGradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Sol vert herbe pixel
    ctx.fillStyle = "#228B22";
    ctx.fillRect(0, canvas.height - 40, canvas.width, 40);

    // Tronc arbre pixel
    ctx.fillStyle = "#8B4513";
    ctx.fillRect(50, canvas.height - 80, 20, 40);
    // Feuillage pixel
    ctx.fillStyle = "#2E8B57";
    ctx.beginPath();
    ctx.moveTo(60, canvas.height - 100);
    ctx.lineTo(90, canvas.height - 80);
    ctx.lineTo(30, canvas.height - 80);
    ctx.closePath();
    ctx.fill();
  }

  // Dessine niveau
  function drawLevel() {
    const level = levels[currentLevel];
    const scale = 16;

    for (const obj of level) {
      if (obj.type === "platform") {
        ctx.fillStyle = "#654321";
        ctx.fillRect(obj.x * scale, obj.y, obj.length * scale, 10);
      }
      if (obj.type === "hole") {
        // rien à dessiner, trou visible par absence de plateforme
      }
      if (obj.type === "laser") {
        const laserX = obj.x * scale + Math.sin(Date.now() / 500) * 20 * obj.dir;
        ctx.fillStyle = "red";
        ctx.fillRect(laserX, obj.y, obj.length * scale, 3 * scale);
        // effet glow
        const grad = ctx.createRadialGradient(
          laserX + (obj.length * scale) / 2,
          obj.y + (3 * scale) / 2,
          5,
          laserX + (obj.length * scale) / 2,
          obj.y + (3 * scale) / 2,
          20
        );
        grad.addColorStop(0, "rgba(255, 0, 0, 0.8)");
        grad.addColorStop(1, "rgba(255, 0, 0, 0)");
        ctx.fillStyle = grad;
        ctx.fillRect(laserX, obj.y, obj.length * scale, 3 * scale);
      }
    }
  }

  // Dessine joueur pixel art cartoon avec animation
  function drawPlayer() {
    const px = player.x * (canvas.width / baseWidth);
    const py = player.y * (canvas.height / baseHeight);
    const w = player.width * (canvas.width / baseWidth);
    const h = player.height * (canvas.height / baseHeight);

    // Couleurs selon skin
    const skinColors = skins[currentSkin];

    // Corps
    ctx.fillStyle = skinColors.body;
    ctx.fillRect(px + w*0.25, py, w*0.5, h*0.35);

    // Torse
    ctx.fillRect(px + w*0.15, py + h*0.35, w*0.7, h*0.6);

    // Jambes animées
    ctx.fillStyle = skinColors.legs;
    if (player.animFrame === 0) {
      ctx.fillRect(px + w*0.15, py + h*0.95, w*0.25, h*0.2);
      ctx.fillRect(px + w*0.55, py + h*0.95, w*0.25, h*0.2);
    } else {
      ctx.fillRect(px + w*0.3, py + h*0.95, w*0.25, h*0.2);
      ctx.fillRect(px + w*0.4, py + h*0.95, w*0.25, h*0.2);
    }

    // Yeux
    ctx.fillStyle = "#000";
    ctx.fillRect(px + w*0.35, py + h*0.1, w*0.1, h*0.1);
    ctx.fillRect(px + w*0.55, py + h*0.1, w*0.1, h*0.1);
  }

  // Flash rouge mort
  let flashAlpha = 0;
  function drawDeathFlash() {
    if (playerDead) {
      flashAlpha += 0.05;
      if (flashAlpha > 0.7) flashAlpha = 0.7;
      ctx.fillStyle = `rgba(255,0,0,${flashAlpha})`;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    } else {
      if (flashAlpha > 0) {
        flashAlpha -= 0.05;
        ctx.fillStyle = `rgba(255,0,0,${flashAlpha})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }
  }

  // Vérifier fin niveau
  function checkLevelComplete() {
    if (player.x + player.width >= baseWidth) {
      levelCompleted = true;
      showMessage("Bravo, niveau terminé !", "Suivant", () => {
        currentLevel++;
        if (currentLevel > maxLevel) {
          alert("Tu as fini tous les niveaux !");
          currentLevel = 0;
        }
        resetPlayer();
        hideMessage();
      });
    }
  }

  // Vérifier mort joueur
  function checkPlayerDead() {
    if (playerDead) {
      showMessage("Tu es mort !", "Recommencer", () => {
        resetPlayer();
        hideMessage();
      });
    }
  }

  // Boucle jeu
  function gameLoop() {
    if (!gamePaused) {
      updatePlayer();
      draw();
      if (!levelCompleted && !playerDead) {
        checkLevelComplete();
        checkPlayerDead();
      }
    }
    requestAnimationFrame(gameLoop);
  }

  function draw() {
    drawBackground();
    drawLevel();
    drawPlayer();
    drawDeathFlash();
  }

  // Charger paramètres sauvegardés
  function loadSettings() {
    const savedControls = localStorage.getItem("platformerControls");
    if (savedControls) {
      controls = JSON.parse(savedControls);
    }
    const savedSpeed = localStorage.getItem("platformerSpeed");
    if (savedSpeed) {
      playerSpeed = parseInt(savedSpeed);
      document.getElementById("speedRange").value = playerSpeed;
      document.getElementById("speedValue").textContent = playerSpeed;
    }
    const savedMusic = localStorage.getItem("platformerMusic");
    if (savedMusic) {
      musicOn = savedMusic === "true";
      document.getElementById("musicToggle").checked = musicOn;
    }
    const savedSound = localStorage.getItem("platformerSound");
    if (savedSound) {
      soundOn = savedSound === "true";
      document.getElementById("soundToggle").checked = soundOn;
    }
    const savedTouch = localStorage.getItem("platformerTouch");
    if (savedTouch) {
      touchButtonsVisible = savedTouch === "true";
      document.getElementById("touchToggle").checked = touchButtonsVisible;
      document.getElementById("touchControls").style.display = touchButtonsVisible ? "flex" : "none";
    }
    const savedSkin = localStorage.getItem("platformerSkin");
    if (savedSkin && skins[savedSkin]) {
      currentSkin = savedSkin;
      document.getElementById("skinSelect").value = currentSkin;
    }

    document.getElementById("keyLeft").value = controls.left.toUpperCase();
    document.getElementById("keyRight").value = controls.right.toUpperCase();
    document.getElementById("keyJump").value = controls.jump.toUpperCase();
  }
  loadSettings();

  // Sauvegarder paramètres
  function saveSettings() {
    localStorage.setItem("platformerControls", JSON.stringify(controls));
    localStorage.setItem("platformerSpeed", playerSpeed.toString());
    localStorage.setItem("platformerMusic", musicOn.toString());
    localStorage.setItem("platformerSound", soundOn.toString());
    localStorage.setItem("platformerTouch", touchButtonsVisible.toString());
    localStorage.setItem("platformerSkin", currentSkin);
  }

  // Ouvrir / fermer menu paramètres
  settingsBtn.addEventListener("click", () => {
    gamePaused = true;
    settingsOverlay.style.display = "block";
  });
  closeSettingsBtn.addEventListener("click", () => {
    gamePaused = false;
    settingsOverlay.style.display = "none";
  });

  // Changement touches
  document.getElementById("keyLeft").addEventListener("input", e => {
    controls.left = e.target.value.toLowerCase();
    saveSettings();
  });
  document.getElementById("keyRight").addEventListener("input", e => {
    controls.right = e.target.value.toLowerCase();
    saveSettings();
  });
  document.getElementById("keyJump").addEventListener("input", e => {
    controls.jump = e.target.value.toLowerCase();
    saveSettings();
  });

  // Changement vitesse joueur
  document.getElementById("speedRange").addEventListener("input", e => {
    playerSpeed = parseInt(e.target.value);
    document.getElementById("speedValue").textContent = playerSpeed;
    saveSettings();
  });

  // Toggle musique
  document.getElementById("musicToggle").addEventListener("change", e => {
    musicOn = e.target.checked;
    // ici tu peux ajouter code pour démarrer/stopper musique
    saveSettings();
  });

  // Toggle sons
  document.getElementById("soundToggle").addEventListener("change", e => {
    soundOn = e.target.checked;
    saveSettings();
  });

  // Toggle boutons tactiles
  document.getElementById("touchToggle").addEventListener("change", e => {
    touchButtonsVisible = e.target.checked;
    document.getElementById("touchControls").style.display = touchButtonsVisible ? "flex" : "none";
    saveSettings();
  });

  // Changement skin
  document.getElementById("skinSelect").addEventListener("change", e => {
    const newSkin = e.target.value;
    if (skins[newSkin]) {
      if (newSkin !== currentSkin) {
        alert(`Tu as débloqué le skin ${newSkin} !`);
      }
      currentSkin = newSkin;
      saveSettings();
    }
  });

  resetPlayer();
  gameLoop();
</script>
</body>
  </html>
  
