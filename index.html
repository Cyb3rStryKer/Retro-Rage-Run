<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Pixel Platformer - Niveau progressif</title>
<style>
  html, body {
    margin:0; padding:0; background: linear-gradient(135deg, #a0d8f7, #5cacee);
    font-family: 'Press Start 2P', cursive, monospace;
    overflow: hidden;
    user-select: none;
  }
  canvas {
    display: block;
    background: #78c0e0 url('https://i.imgur.com/IxFSSpG.png') repeat; /* pixel sky pattern */
    image-rendering: pixelated;
    margin: 0 auto;
    box-shadow: 0 0 30px #4a90e2aa;
    border: 3px solid #3377cc;
    border-radius: 8px;
  }
  #ui {
    position: fixed;
    top: 10px; left: 50%;
    transform: translateX(-50%);
    color: white;
    text-shadow: 0 0 6px #000a;
    font-size: 18px;
    font-weight: bold;
    user-select: none;
    z-index: 50;
  }
  #btnLeft, #btnRight, #btnJump {
    position: fixed;
    bottom: 40px;
    width: 64px; height: 64px;
    background: #4488eecc;
    border-radius: 12px;
    border: 2px solid #3366cc;
    box-shadow: 0 4px 0 #224499;
    font-size: 30px;
    color: white;
    text-align: center;
    line-height: 64px;
    user-select: none;
  }
  #btnLeft { left: 20px; }
  #btnRight { left: 100px; }
  #btnJump { right: 20px; }
  #btnLeft:active, #btnRight:active, #btnJump:active {
    background: #3366ccdd;
    box-shadow: 0 2px 0 #224488;
  }
  #settingsBtn {
    position: fixed;
    top: 10px; right: 20px;
    width: 36px; height: 36px;
    background: #3366ccee;
    border-radius: 50%;
    border: 2px solid #224488;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 8px #224488aa;
    transition: background 0.3s;
    z-index: 100;
  }
  #settingsBtn:hover {
    background: #224488ee;
  }
  #settingsBtn svg {
    fill: white;
    width: 22px;
    height: 22px;
  }
  #settingsPanel {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #224488ee;
    border-radius: 12px;
    padding: 20px 30px;
    width: 320px;
    box-shadow: 0 0 40px #224488dd;
    color: white;
    font-size: 16px;
    z-index: 200;
    display: none;
    user-select: none;
  }
  #settingsPanel label {
    display: block;
    margin-top: 12px;
  }
  #settingsPanel select, #settingsPanel input[type="text"] {
    margin-top: 6px;
    width: 100%;
    padding: 6px 8px;
    border-radius: 6px;
    border: none;
    font-size: 16px;
  }
  #settingsCloseBtn {
    margin-top: 20px;
    background: #5577cc;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
  }
  #messageBox {
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(33, 66, 122, 0.95);
    border-radius: 16px;
    padding: 30px 40px;
    box-shadow: 0 0 30px #224488cc;
    color: white;
    text-align: center;
    font-size: 22px;
    font-weight: 700;
    user-select: none;
    z-index: 300;
    display: none;
  }
  #messageBox button {
    margin-top: 18px;
    background: #66aaff;
    border: none;
    border-radius: 12px;
    padding: 12px 20px;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 4px 0 #224488;
    transition: background 0.3s;
  }
  #messageBox button:hover {
    background: #5599ff;
  }
  /* Pixel font from Google Fonts */
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="ui">Niveau: 1 / 100 | Peau: Basic</div>

<button id="btnLeft" aria-label="Déplacer à gauche">◀</button>
<button id="btnRight" aria-label="Déplacer à droite">▶</button>
<button id="btnJump" aria-label="Sauter">▲</button>

<div id="settingsBtn" title="Paramètres" role="button" tabindex="0" aria-pressed="false">
  <svg viewBox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7zm7.43-1.5c.06-.33.1-.66.1-1s-.04-.67-.1-1l2.11-1.65a.5.5 0 0 0 .12-.62l-2-3.46a.5.5 0 0 0-.6-.22l-2.49 1a7.037 7.037 0 0 0-1.73-1l-.38-2.65a.5.5 0 0 0-.5-.44h-4a.5.5 0 0 0-.5.44l-.38 2.65a7.037 7.037 0 0 0-1.73 1l-2.49-1a.5.5 0 0 0-.6.22l-2 3.46a.5.5 0 0 0 .12.62L4.47 12c-.06.33-.1.66-.1 1s.04.67.1 1l-2.11 1.65a.5.5 0 0 0-.12.62l2 3.46c.14.24.44.34.7.22l2.49-1a7.037 7.037 0 0 0 1.73 1l.38 2.65c.04.26.25.44.5.44h4c.25 0 .46-.18.5-.44l.38-2.65a7.037 7.037 0 0 0 1.73-1l2.49 1c.26.12.56.02.7-.22l2-3.46a.5.5 0 0 0-.12-.62L19.43 14z"/></svg>
</div>

<div id="settingsPanel" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <h2 id="settingsTitle">Paramètres</h2>
  <label for="languageSelect">Langue:</label>
  <select id="languageSelect" aria-describedby="languageDesc">
    <option value="fr">Français</option>
    <option value="en">English</option>
    <option value="de">Deutsch</option>
    <option value="es">Español</option>
  </select>
  <label for="skinSelect">Peau:</label>
  <select id="skinSelect"></select>
  <label for="keyLeft">Touche Gauche:</label>
  <input type="text" id="keyLeft" maxlength="1" aria-describedby="keyLeftDesc" />
  <label for="keyRight">Touche Droite:</label>
  <input type="text" id="keyRight" maxlength="1" aria-describedby="keyRightDesc" />
  <label for="keyJump">Touche Saut:</label>
  <input type="text" id="keyJump" maxlength="1" aria-describedby="keyJumpDesc" />
  <button id="settingsCloseBtn">Fermer</button>
</div>

<div id="messageBox" role="alert" aria-live="assertive">
  <div id="messageText"></div>
  <button id="messageButton"></button>
</div>

<script>
(() => {
  // --- Config & constants ---
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const baseWidth = 640;
  const baseHeight = 360;
  let scale = 1;

  const tileSize = 16;
  const mapWidth = 40; // en tiles
  const mapHeight = 22;

  const totalLevels = 100;

  const gravity = 0.55;
  const terminalVelocity = 12;

  // --- State ---
  let currentLevel = 0;
  let keysDown = {};
  let mobileInput = { left: false, right: false, jump: false };
  let gamePaused = false;
  let inMessage = false;

  let lang = 'fr';

  // --- Textes multilingues ---
  const texts = {
    fr: {
      dead: "Vous êtes mort !",
      win: "Niveau terminé !",
      newSkin: "Peau déverrouillée : ",
      restart: "Recommencer",
      next: "Niveau suivant",
      skins: "Peaux",
      settings: "Paramètres",
      language: "Langue",
      controls: "Contrôles",
      skinUnlocked: "Peau débloquée !",
    },
    en: {
      dead: "You died!",
      win: "Level completed!",
      newSkin: "Skin unlocked: ",
      restart: "Restart",
      next: "Next level",
      skins: "Skins",
      settings: "Settings",
      language: "Language",
      controls: "Controls",
      skinUnlocked: "Skin unlocked!",
    },
    de: {
      dead: "Du bist gestorben!",
      win: "Level abgeschlossen!",
      newSkin: "Skin freigeschaltet: ",
      restart: "Neu starten",
      next: "Nächstes Level",
      skins: "Skins",
      settings: "Einstellungen",
      language: "Sprache",
      controls: "Steuerung",
      skinUnlocked: "Skin freigeschaltet!",
    },
    es: {
      dead: "¡Has muerto!",
      win: "¡Nivel completado!",
      newSkin: "Piel desbloqueada: ",
      restart: "Reiniciar",
      next: "Siguiente nivel",
      skins: "Pieles",
      settings: "Configuración",
      language: "Idioma",
      controls: "Controles",
      skinUnlocked: "¡Piel desbloqueada!",
    }
  };

  // --- Skins ---
  const skins = {
    basic: { name: "Basic", color: "#2288ff", eyes: "#fff" },
    red: { name: "Red", color: "#cc4422", eyes: "#fff" },
    green: { name: "Green", color: "#22cc44", eyes: "#000" },
    yellow: { name: "Yellow", color: "#e8d122", eyes: "#000" },
    purple: { name: "Purple", color: "#8822cc", eyes: "#fff" },
  };
  let unlockedSkins = ['basic']; // unlocked progressively

  // --- Player ---
  const player = {
    x: 40, y: 0,
    width: 14, height: 18,
    vx: 0, vy: 0,
    speed: 3.2,
    jumpPower: 10,
    grounded: false,
    alive: true,
    skin: 'basic',
  };

  // --- Controls ---
  let controls = {
    left: 'a',
    right: 'd',
    jump: 'w',
  };

  // --- Level data ---
  // Tiles: 0 = empty, 1 = platform, 2 = spikes, 3 = laser
  // We'll generate levels progressively

  // Laser animation state
  let laserAnimFrame = 0;
  let laserDir = 1;

  // --- Canvas & resize ---
  function resize() {
    const winW = window.innerWidth;
    const winH = window.innerHeight;
    scale = Math.min(winW / baseWidth, winH / baseHeight);
    canvas.width = baseWidth;
    canvas.height = baseHeight;
    canvas.style.width = baseWidth * scale + 'px';
    canvas.style.height = baseHeight * scale + 'px';
  }
  window.addEventListener('resize', resize);
  resize();

  // --- Utility ---
  function clamp(x, min, max){ return Math.min(Math.max(x, min), max); }

  // --- Save/load settings ---
  function saveSettings() {
    const data = {
      controls,
      skin: player.skin,
      unlockedSkins,
      lang,
      currentLevel,
    };
    localStorage.setItem('pixelPlatformerSave', JSON.stringify(data));
  }
  function loadSettings() {
    const data = JSON.parse(localStorage.getItem('pixelPlatformerSave'));
    if(data){
      if(data.controls) controls = data.controls;
      if(data.skin && skins[data.skin]) player.skin = data.skin;
      if(data.unlockedSkins) unlockedSkins = data.unlockedSkins;
      if(data.lang) lang = data.lang;
      if(data.currentLevel !== undefined) currentLevel = data.currentLevel;
    }
  }
  loadSettings();

  // --- Generate level with progressive difficulty ---
  function generateLevel(n) {
    let grid = Array(mapHeight).fill(null).map(() => Array(mapWidth).fill(0));

    // Base floor
    for(let x=0; x<mapWidth; x++){
      grid[mapHeight-1][x] = 1;
    }

    // Difficulty params growing with level
    const platformCount = 6 + Math.min(n, 34);
    const maxGap = Math.min(5 + Math.floor(n/5), 10);
    const maxHeight = Math.max(5, mapHeight - 6 - Math.floor(n/6));

    for(let i=0; i<platformCount; i++){
      let px = Math.floor(Math.random() * (mapWidth - 6)) + 1;
      let py = Math.floor(Math.random() * (maxHeight - 4)) + 4;

      // Platform of 3 tiles
      for(let w=0; w<3; w++){
        if(px + w < mapWidth)
          grid[py][px + w] = 1;
      }

      // Add spikes with increasing chance
      if(Math.random() < 0.25 + n * 0.01){
        if(py > 0 && px + 1 < mapWidth)
          grid[py - 1][px + 1] = 2;
      }

      // Add holes in floor with increasing chance
      if(Math.random() < 0.15 + n * 0.01){
        if(px + 1 < mapWidth)
          grid[mapHeight - 1][px + 1] = 0;
      }

      // Add laser with increasing chance
      if(Math.random() < 0.15 + n * 0.01){
        if(px + 2 < mapWidth)
          grid[py][px + 2] = 3;
      }
    }

    // Start platform
    grid[mapHeight-2][1] = 1;
    grid[mapHeight-2][2] = 1;

    // Goal platform at right
    grid[mapHeight-2][mapWidth-4] = 1;
    grid[mapHeight-2][mapWidth-3] = 1;

    return grid;
  }

  // --- Levels cache ---
  let levels = [];
  for(let i=0; i<totalLevels; i++){
    levels.push(generateLevel(i));
  }

  // --- Drawing helpers ---
  function drawTile(x, y, type) {
    const px = x * tileSize;
    const py = y * tileSize;
    switch(type){
      case 1: // Platform
        // Cartoon pixel platform with shade
        ctx.fillStyle = '#4455cc';
        ctx.fillRect(px, py, tileSize, tileSize);
        ctx.fillStyle = '#7788ff';
        ctx.fillRect(px+2, py+2, tileSize-4, tileSize-4);
        ctx.strokeStyle = '#3344aa';
        ctx.lineWidth = 1;
        ctx.strokeRect(px, py, tileSize, tileSize);
        break;
      case 2: // Spikes
        ctx.fillStyle = '#cc2222';
        for(let i=0; i<3; i++){
          ctx.beginPath();
          ctx.moveTo(px + i*5, py + tileSize);
          ctx.lineTo(px + 2 + i*5, py + 5);
          ctx.lineTo(px + 5 + i*5, py + tileSize);
          ctx.closePath();
          ctx.fill();
          ctx.strokeStyle = '#990000';
          ctx.stroke();
        }
        break;
      case 3: // Laser (animated)
        const anim = Math.floor(laserAnimFrame) % 4;
        ctx.fillStyle = ['#ff2222','#ff5555','#ff2222','#ff0000'][anim];
        ctx.fillRect(px+4, py+4, tileSize-8, tileSize-8);
        ctx.strokeStyle = '#aa0000';
        ctx.lineWidth = 1;
        ctx.strokeRect(px+4, py+4, tileSize-8, tileSize-8);
        // Laser beam
        ctx.strokeStyle = '#ff4444';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(px + tileSize/2, py + tileSize/2);
        ctx.lineTo(px + tileSize/2, py - 10);
        ctx.stroke();
        break;
      default: // empty
        // Could draw some subtle ground pattern
        break;
    }
  }

  function drawPlayer(){
    const px = player.x - player.width/2;
    const py = player.y - player.height;

    // Body
    ctx.fillStyle = skins[player.skin].color;
    ctx.fillRect(px, py, player.width, player.height);

    // Eyes (simple)
    ctx.fillStyle = skins[player.skin].eyes;
    ctx.fillRect(px + 3, py + 4, 3, 3);
    ctx.fillRect(px + player.width - 7, py + 4, 3, 3);

    // Smile (simple)
    ctx.strokeStyle = skins[player.skin].eyes;
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.moveTo(px + 4, py + player.height - 6);
    ctx.quadraticCurveTo(px + player.width/2, py + player.height - 2, px + player.width - 5, py + player.height - 6);
    ctx.stroke();
  }

  // --- Collision ---
  function tileAt(x, y) {
    const tx = Math.floor(x / tileSize);
    const ty = Math.floor(y / tileSize);
    if(tx < 0 || tx >= mapWidth || ty < 0 || ty >= mapHeight) return 0;
    return levels[currentLevel][ty][tx];
  }

  function checkCollision(x, y, w, h){
    // Check all corners and edges
    const left = x;
    const right = x + w;
    const top = y;
    const bottom = y + h;

    const collisions = [];

    // Check points in bounding box
    for(let px = left; px <= right; px += tileSize/2){
      for(let py = top; py <= bottom; py += tileSize/2){
        let t = tileAt(px, py);
        if(t && t !== 0) collisions.push(t);
      }
    }
    return collisions;
  }

  // --- Game Loop ---
  let lastTime = 0;

  // Input handling
  window.addEventListener('keydown', e => {
    if(inMessage) return;
    keysDown[e.key.toLowerCase()] = true;
    e.preventDefault();
  });
  window.addEventListener('keyup', e => {
    keysDown[e.key.toLowerCase()] = false;
    e.preventDefault();
  });

  // Touch buttons input
  document.getElementById('btnLeft').addEventListener('touchstart', e => { mobileInput.left = true; e.preventDefault(); });
  document.getElementById('btnLeft').addEventListener('touchend', e => { mobileInput.left = false; e.preventDefault(); });
  document.getElementById('btnRight').addEventListener('touchstart', e => { mobileInput.right = true; e.preventDefault(); });
  document.getElementById('btnRight').addEventListener('touchend', e => { mobileInput.right = false; e.preventDefault(); });
  document.getElementById('btnJump').addEventListener('touchstart', e => { mobileInput.jump = true; e.preventDefault(); });
  document.getElementById('btnJump').addEventListener('touchend', e => { mobileInput.jump = false; e.preventDefault(); });

  // --- Laser animation speed ---
  function updateLasers() {
    const baseSpeed = 0.1;
    const speed = Math.min(baseSpeed + currentLevel * 0.007, 0.35);
    laserAnimFrame += laserDir * speed;
    if(laserAnimFrame >= 3) laserDir = -1;
    if(laserAnimFrame <= 0) laserDir = 1;
  }

  // --- Messages ---
  const messageBox = document.getElementById('messageBox');
  const messageText = document.getElementById('messageText');
  const messageButton = document.getElementById('messageButton');

  function showMessage(text, buttonText, callback) {
    inMessage = true;
    messageText.textContent = text;
    messageButton.textContent = buttonText;
    messageBox.style.display = 'block';
    messageButton.onclick = () => {
      messageBox.style.display = 'none';
      inMessage = false;
      callback();
    };
  }

  // --- Start next level ---
  function startLevel(n){
    currentLevel = clamp(n, 0, totalLevels-1);
    player.x = tileSize * 3;
    player.y = tileSize * (mapHeight - 3);
    player.vx = 0;
    player.vy = 0;
    player.grounded = false;
    player.alive = true;
    updateUI();
    saveSettings();
  }

  // --- Update UI ---
  const ui = document.getElementById('ui');
  const skinSelect = document.getElementById('skinSelect');
  function updateUI(){
    ui.textContent = `Niveau: ${currentLevel + 1} / ${totalLevels} | Peau: ${skins[player.skin].name}`;
  }

  // --- Skins UI ---
  function initSkinSelect(){
    skinSelect.innerHTML = '';
    for(const key in skins){
      const opt = document.createElement('option');
      opt.value = key;
      opt.textContent = skins[key].name + (unlockedSkins.includes(key) ? '' : ' 🔒');
      if(!unlockedSkins.includes(key)) opt.disabled = true;
      if(key === player.skin) opt.selected = true;
      skinSelect.appendChild(opt);
    }
  }
  initSkinSelect();

  skinSelect.addEventListener('change', () => {
    if(unlockedSkins.includes(skinSelect.value)){
      player.skin = skinSelect.value;
      updateUI();
      saveSettings();
    } else {
      alert('Cette peau est verrouillée!');
      skinSelect.value = player.skin;
    }
  });

  // --- Settings panel ---
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPanel = document.getElementById('settingsPanel');
  const settingsCloseBtn = document.getElementById('settingsCloseBtn');

  // Controls inputs
  const keyLeftInput = document.getElementById('keyLeft');
  const keyRightInput = document.getElementById('keyRight');
  const keyJumpInput = document.getElementById('keyJump');
  const languageSelect = document.getElementById('languageSelect');

  function loadControlsUI(){
    keyLeftInput.value = controls.left.toUpperCase();
    keyRightInput.value = controls.right.toUpperCase();
    keyJumpInput.value = controls.jump.toUpperCase();
    languageSelect.value = lang;
  }
  loadControlsUI();

  settingsBtn.onclick = () => {
    settingsPanel.style.display = 'block';
    settingsBtn.setAttribute('aria-pressed', 'true');
  };
  settingsCloseBtn.onclick = () => {
    settingsPanel.style.display = 'none';
    settingsBtn.setAttribute('aria-pressed', 'false');
    saveSettings();
  };

  languageSelect.onchange = () => {
    lang = languageSelect.value;
    updateUI();
    saveSettings();
  };

  // Controls input validation
  function sanitizeKeyInput(input){
    if(!input) return '';
    return input.toLowerCase().substring(0,1);
  }

  keyLeftInput.oninput = () => {
    const k = sanitizeKeyInput(keyLeftInput.value);
    if(k){
      controls.left = k;
      keyLeftInput.value = k.toUpperCase();
      saveSettings();
    }
  };
  keyRightInput.oninput = () => {
    const k = sanitizeKeyInput(keyRightInput.value);
    if(k){
      controls.right = k;
      keyRightInput.value = k.toUpperCase();
      saveSettings();
    }
  };
  keyJumpInput.oninput = () => {
    const k = sanitizeKeyInput(keyJumpInput.value);
    if(k){
      controls.jump = k;
      keyJumpInput.value = k.toUpperCase();
      saveSettings();
    }
  };

  // --- Game update ---
  function update(delta) {
    if(gamePaused || inMessage) return;

    updateLasers();

    // Input
    let moveLeft = keysDown[controls.left] || mobileInput.left;
    let moveRight = keysDown[controls.right] || mobileInput.right;
    let jumpPressed = (keysDown[controls.jump] || mobileInput.jump);

    // Horizontal movement
    if(moveLeft && !moveRight){
      player.vx = -player.speed;
    } else if(moveRight && !moveLeft){
      player.vx = player.speed;
    } else {
      player.vx = 0;
    }

    // Jump
    if(jumpPressed && player.g
